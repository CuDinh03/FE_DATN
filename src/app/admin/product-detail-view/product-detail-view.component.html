<app-sidebar></app-sidebar>

<div class="card justify-content-center">
  <p-panel header="Quản lý sản phẩm" [toggleable]="true">
    <p-toast/>

    <p-table
      #dt
      [value]="listSanPhamChiTiet"
      [rows]="10"
      [paginator]="true"
      [globalFilterFields]="['name', 'country.name', 'representative.name', 'status']"
      [tableStyle]="{ 'min-width': '75rem' }"
      [(selection)]="selectedProducts"
      [rowHover]="true"
      dataKey="id"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      [showCurrentPageReport]="true"
    >
      <ng-template pTemplate="caption">

        <div class="flex align-items-center justify-content-between">
          <h5 class="m-0">Danh sách sản phẩm</h5>
          <!--          <span class="p-input-icon-left">-->
          <!--                    <i class="pi pi-search"></i>-->
          <!--                    <input-->
          <!--                      pInputText-->
          <!--                      type="text"-->
          <!--                      (input)="dt?.filterGlobal($event.target.value, 'contains')"-->
          <!--                      placeholder="Search..." />-->
          <!--                </span>-->
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 4rem">
            <p-tableHeaderCheckbox/>
          </th>
          <th pSortableColumn="ten" style="min-width: 15rem">
            Tên sản phẩm
            <p-sortIcon field="ten"></p-sortIcon>
          </th>
          <th>
            Ảnh
          </th>
          <th pSortableColumn="giaBam">
            Giá bán
            <p-sortIcon field="giaBan"/>
          </th>
          <th pSortableColumn="category" style="min-width:10rem">
            Danh mục
            <p-sortIcon field="category"/>
          </th>
          <th pSortableColumn="quantity">
            Số lượng
            <p-sortIcon field="quantity"/>
          </th>
          <th pSortableColumn="inventoryStatus" style="min-width:10rem">
            Status
            <p-sortIcon field="inventoryStatus"/>
          </th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-product>
        <tr>
          <td>
            <p-tableCheckbox [value]="product"/>
          </td>
          <td>
            {{ product.sanPham.ten }}
            <p style="color: #B5C0D0; font-size: 12px">[{{ product.mauSac.ten }} - {{ product.kichThuoc.ten }}]</p>
          </td>
          <td>
            <div *ngFor="let aurl of listHinhAnh">
              <ng-container *ngIf="aurl.chiTietSanPham.id === product.id">
                <img
                  [src]="aurl.url"
                  [alt]="product.sanPham.ten"
                  width="50"
                  class="shadow-4"/>
              </ng-container>
            </div>
          </td>
          <td>
            {{ product.giaBan | currency : 'USD' }}
          </td>
          <td>
            {{ product.danhMuc.ten }}
          </td>
          <td>
            {{ product.soLuong }}
          </td>
          <td>
            <p-tag [value]="product.trangThai === 1 ? 'Còn hàng' : (product.trangThai === 0 ? 'Sắp hết' : 'Hết hàng')"
                   [severity]="getSeverity(product.trangThai)"></p-tag>
          </td>
          <td>
            <p-button
              pRipple
              icon="pi pi-pencil"
              class="mr-2"
              [rounded]="true"
              [outlined]="true"
              severity="success"
              (click)="editProduct(product)"/>
            <p-button
              pRipple
              icon="pi pi-trash"
              severity="danger"
              [rounded]="true"
              [outlined]="true"
              (click)="deleteProduct(product)"/>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="summary">
        <div class="flex align-items-center justify-content-between">
          Có tổng {{ listSanPhamChiTiet ? listSanPhamChiTiet.length : 0 }} sản phẩm.
        </div>
      </ng-template>
    </p-table>

    <p-dialog
      [(visible)]="productDialog"
      [style]="{ width: '450px' }"
      header="Chi tiết sản phẩm"
      [modal]="true"
      styleClass="p-fluid">
      <ng-template pTemplate="content">
        <div *ngFor="let aurl of listHinhAnh">
          <ng-container *ngIf="aurl.chiTietSanPham.id === product.id">
            <img
              [src]="aurl.url"
              [alt]="product.sanPham.ten"
              width="500"
              class="block m-auto pb-3"
              *ngIf="product.hinhAnh"/>
          </ng-container>
        </div>
        <div class="field">
          <label for="name">Tên</label>
          <input
            type="text"
            pInputText
            id="name"
            [(ngModel)]="product.sanPham.ten"
            required
            autofocus/>
          <small class="p-error" *ngIf="submitted && !product.sanPham.ten">
            Name is required.
          </small>
        </div>


        <div class="field">
          <label class="mb-3">Danh mục</label>
          <div class="formgrid grid">
            <div class="field-radiobutton col-6">
              <p-radioButton
                id="category1"
                name="{{product.danhMuc.ten}}"
                value="{{product.danhMuc.ten}}"
                [(ngModel)]="product.danhMuc.ten"/>
              <label for="category1">{{product.danhMuc.ten}}</label>
            </div>
            <!--              <div class="field-radiobutton col-6">-->
            <!--                <p-radioButton-->
            <!--                  id="category2"-->
            <!--                  name="category"-->
            <!--                  value="Clothing"-->
            <!--                  [(ngModel)]="product.danhMuc.ten"/>-->
            <!--                <label for="category2">Clothing</label>-->
            <!--              </div>-->
          </div>
        </div>

        <div class="formgrid grid">
          <div class="field col">
            <label for="price">Giá bán</label>
            <p-inputNumber
              id="price"
              [(ngModel)]="product.giaBan"
              mode="currency"
              currency="USD"
              locale="en-US"/>
          </div>
          <div class="field col">
            <label for="quantity">số lượng</label>
            <p-inputNumber
              id="quantity"
              [(ngModel)]="product.soLuong"/>
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="footer">
        <p-button
          pRipple
          label="Cancel"
          icon="pi pi-times"
          [text]="true"
          (click)="hideDialog()"/>
        <p-button
          pRipple
          label="Save"
          icon="pi pi-check"
          [text]="true"
          (click)="saveProduct()"/>
      </ng-template>
    </p-dialog>

    <p-confirmDialog [style]="{ width: '450px' }"/>
    <p-toolbar styleClass="mb-4 gap-2">
      <ng-template pTemplate="right">
        <p-button
          pRipple
          severity="danger"
          label="Xóa"
          icon="pi pi-trash"
          (click)="deleteSelectedProducts()"
          [disabled]="!selectedProducts || !selectedProducts.length"
        ></p-button>
      </ng-template>
    </p-toolbar>
  </p-panel>
</div>


<div class="card">
  <h5 class="card-title fw-semibold">Sản phẩm</h5>
  <!--              <div class="d-flex justify-content-end">-->
  <!--              </div>-->
  <div class="row">
    <div class="col-6">
      <label class="col-3" >Sản phẩm</label>
      <p-multiSelect [options]="listSanPham"
                     [(ngModel)]="selectedSanPham"
                     placeholder="Chọn Sản phẩm"
                     optionLabel="ten"
                     class="col-3">
        <ng-template let-value pTemplate="selectedItems">
          <div class="inline-flex align-items-center gap-2 px-1" *ngFor="let option of value">
            <div>{{ option.ten }},</div>
          </div>
          <div *ngIf="!value || value.length === 0">Chọn Sản phẩm</div>
        </ng-template>
        <ng-template let-sp pTemplate="item">
          <div class="flex align-items-center gap-2">
            <div>{{ sp.ten }}</div>
          </div>
        </ng-template>
        <ng-template pTemplate="footer">
          <div class="py-2 px-3">
            <b>
              {{ selectedSanPham ? selectedSanPham.length : 0 }}
            </b>
            Sản phẩm{{ (selectedSanPham ? selectedSanPham.length : 0) > 1 ? 's' : '' }} đã chọn.
          </div>
        </ng-template>
      </p-multiSelect>
    </div>
    <p-button label="Thêm biến thể" icon="pi pi-plus" iconPos="right" (click)="addChiTietSanPham()"/>
  </div>
  <br>
  <h5>Thuộc tính</h5>
  <hr>
  <div class="row mt-2">
    <div class="col-6">
      <label class="col-3">Chất liệu</label>
      <p-multiSelect [options]="listChatLieu"
                     [(ngModel)]="selectedChatLieu"
                     placeholder="Chọn Chất liệu"
                     optionLabel="ten"
                     class="col-3">
        <ng-template let-value pTemplate="selectedItems">
          <div class="inline-flex align-items-center gap-2 px-1" *ngFor="let option of value">
            <div>{{ option.ten }},</div>
          </div>
          <div *ngIf="!value || value.length === 0">Chọn Chất liệu</div>
        </ng-template>
        <ng-template let-cl pTemplate="item">
          <div class="flex align-items-center gap-2">
            <div>{{ cl.ten }}</div>
          </div>
        </ng-template>
        <ng-template pTemplate="footer">
          <div class="py-2 px-3">
            <b>
              {{ selectedChatLieu ? selectedChatLieu.length : 0 }}
            </b>
            Chất liệu{{ (selectedChatLieu ? selectedChatLieu.length : 0) > 1 ? 's' : '' }} đã chọn.
          </div>
        </ng-template>
      </p-multiSelect>
    </div>

    <div class="col-6">
      <label class="col-3">Thương hiệu</label>
      <p-multiSelect [options]="listThuongHieu"
                     [(ngModel)]="selectedThuongHieu"
                     placeholder="Chọn Thương hiệu"
                     optionLabel="ten" class="col-3">
        <ng-template  let-value pTemplate="selectedItems">
          <div class="inline-flex align-items-center gap-2 px-1" *ngFor="let option of value">
            <div>{{ option.ten }},</div>
          </div>
          <div *ngIf="!value || value.length === 0">Chọn Thương hiệu</div>
        </ng-template>
        <ng-template let-th pTemplate="item">
          <div class="flex align-items-center gap-2">
            <div>{{ th.ten }}</div>
          </div>
        </ng-template>
        <ng-template pTemplate="footer">
          <div class="py-2 px-3">
            <b>
              {{ selectedThuongHieu ? selectedThuongHieu.length : 0 }}
            </b>
            Thương hiệu{{ (selectedThuongHieu ? selectedThuongHieu.length : 0) > 1 ? 's' : '' }} đã chọn.
          </div>
        </ng-template>
      </p-multiSelect>
    </div>
  </div>
  <div class="row mt-2">

    <div class="col-6">
      <label class="col-3">Danh mục</label>
      <p-multiSelect [options]="listDanhMuc"
                     [(ngModel)]="selectedDanhMuc"
                     placeholder="Chọn Danh mục"
                     optionLabel="ten" class="col-3">
        <ng-template let-value pTemplate="selectedItems">
          <div class="inline-flex align-items-center gap-2 px-1" *ngFor="let option of value">
            <div>{{ option.ten }},</div>
          </div>
          <div *ngIf="!value || value.length === 0">Chọn Danh mục</div>
        </ng-template>
        <ng-template let-dm pTemplate="item">
          <div class="flex align-items-center gap-2">
            <div>{{ dm.ten }}</div>
          </div>
        </ng-template>
        <ng-template pTemplate="footer">
          <div class="py-2 px-3">
            <b>
              {{ selectedDanhMuc ? selectedDanhMuc.length : 0 }}
            </b>
            Danh mục{{ (selectedDanhMuc ? selectedDanhMuc.length : 0) > 1 ? 's' : '' }} đã chọn.
          </div>
        </ng-template>
      </p-multiSelect>
    </div>

    <div class="col-6">
      <label class="col-3">Size</label>

      <p-multiSelect
        [options]="listKichThuoc"
        [(ngModel)]="selectedSizes"
        placeholder="Chọn Size"
        optionLabel="ten" class="col-3">
        <ng-template let-value pTemplate="selectedItems">
          <div class="inline-flex align-items-center gap-2 px-1" *ngFor="let option of value">
            <div>{{ option.ten }},</div>
          </div>
          <div *ngIf="!value || value.length === 0">Chọn Size</div>
        </ng-template>
        <ng-template let-kt pTemplate="item">
          <div class="flex align-items-center gap-2">
            <div>{{ kt.ten }}</div>
          </div>
        </ng-template>
        <ng-template let-kt pTemplate="footer">
          <div class="py-2 px-3">
            <b>
              {{ selectedSizes ? selectedSizes.length : 0 }}
            </b>
            Size{{ (selectedSizes ? selectedSizes.length : 0) > 1 ? 's' : '' }} đã chọn.
          </div>
        </ng-template>
      </p-multiSelect>

    </div>
  </div>
  <div class="row mt-2">
    <div class="col-6">

      <label class="col-3">Màu sắc</label>
      <p-multiSelect
        [options]="listMauSac"
        [(ngModel)]="selectedColors"
        placeholder="Chọn màu sắc"
        optionLabel="ten" class="col-3">
        <ng-template let-value pTemplate="selectedItems">
          <div class="inline-flex align-items-center gap-2 px-1" *ngFor="let option of value">
            <div>{{ option.ten }},</div>
          </div>
          <div *ngIf="!value || value.length === 0">Chọn màu sắc</div>
        </ng-template>
        <ng-template let-ms pTemplate="item">
          <div class="flex align-items-center gap-2">
            <div>{{ ms.ten }}</div>
          </div>
        </ng-template>
        <ng-template let-ms pTemplate="footer">
          <div class="py-2 px-3">
            <b>
              {{ selectedColors ? selectedColors.length : 0 }}
            </b>
            Màu sắc{{ (selectedColors ? selectedColors.length : 0) > 1 ? 's' : '' }} đã chọn.
          </div>
        </ng-template>
      </p-multiSelect>
    </div>
  </div>
  <div class="row mt-2">
    <ng-container
      *ngIf="selectedSizes && selectedSizes.length > 0 && selectedColors && selectedColors.length >0">
      <ng-container *ngFor="let ms of selectedColors">
        <p class="col-12 " >Sản phẩm có màu {{ ms.ten }}</p>
        <label [style.backgroundColor]="ms.ma" >|</label>
        <hr class="mt-5">
        <p-table [value]="selectedListSp" [tableStyle]="{ 'min-width': '50rem' }" class="col-12">
          <ng-template pTemplate="header">
            <tr>
              <th>Sản phẩm</th>
              <th>Thương hiệu</th>
              <th>Chất liệu</th>
              <th>Danh mục</th>
              <th>Kích thước</th>
              <th>Màu sắc</th>
              <th>Số lượng</th>
              <th>Giá nhập</th>
              <th>Giá bán</th>
              <th>IMG</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-ctsp let-i="rowIndex">
            <tr *ngIf="ctsp.mauSac.ten === ms.ten ">
              <td>{{ ctsp.sanPham.ten }}</td>
              <td>{{ ctsp.thuongHieu.ten }}</td>
              <td>{{ ctsp.chatLieu.ten }}</td>
              <td>{{ ctsp.danhMuc.ten }}</td>
              <td>{{ ctsp.kichThuoc.ten }}</td>
              <td>{{ ctsp.mauSac.ten }}</td>
              <td><p-inputNumber
                inputId="integeronly"
                [(ngModel)]="ctsp.soLuong"/></td>
              <td><p-inputNumber
                inputId="integeronly"
                [(ngModel)]="ctsp.giaNhap"/></td>
              <td><p-inputNumber
                inputId="integeronly"
                [(ngModel)]="ctsp.giaBan"/></td>
              <!-- Hiển thị ảnh -->
              <td>
                <p-toast />
                <p-fileUpload
                  name="demo[]"
                  url="https://www.primefaces.org/cdn/api/upload.php"
                  (onUpload)="onFileChange($event, ctsp, i)"
                  [multiple]="true"
                  accept="image/*"
                  maxFileSize="10000000">
                  <ng-template pTemplate="content">
                    <li *ngFor="let file of ctsp.hinhAnhUrls">
                      {{ file.name }} - {{ file.size }} bytes
                    </li>

                  </ng-template>
                </p-fileUpload>
              </td>
            </tr>
            <tr>
              <div *ngIf="ctsp.hinhAnhUrls && ctsp.hinhAnhUrls.length > 0" class="image-gallery">
                <h5>Hình ảnh đã tải lên:</h5>
                <div class="image-list">
                  <img *ngFor="let url of ctsp.hinhAnhUrls" [src]="url" class="uploaded-image" />
                </div>
              </div>
            </tr>
          </ng-template>
        </p-table>
      </ng-container>
    </ng-container>


  </div>
  <br>
  <button  pButton
           pRipple
           label="Lưu các biến thể"
           class="p-button-success" (click)="confirm()"></button>
</div>

<div class="card flex justify-content-center">
  <p-toast />
</div>
